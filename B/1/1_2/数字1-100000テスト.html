<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—ã®å­¦ç¿’ - ãƒœãƒ¼ãƒ‰æ—¥æœ¬èªåŒ–</title>
    <style>
        body { font-family: 'Hiragino Sans', sans-serif; background: #fff9e6; text-align: center; margin: 0; }
        .container { max-width: 750px; margin: 20px auto; background: white; padding: 30px; border-radius: 30px; box-shadow: 0 15px 30px rgba(0,0,0,0.1); position: relative; min-height: 600px; border: 8px solid #ffeb3b; }
        
        /* Furigana Styling */
        ruby { ruby-align: center; }
        rt { font-size: 0.45em; color: #666; font-weight: normal; }

        /* Stats Corner - CHUYá»‚N SANG TIáº¾NG NHáº¬T */
        #stats { 
            position: absolute; 
            top: 15px; 
            right: 20px; 
            text-align: right; 
            font-weight: bold; 
            font-size: 17px; 
            z-index: 5; 
            line-height: 1.6;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 10px;
        }
        
        /* 3D Effects */
        #effect-layer { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 180px; pointer-events: none; z-index: 100; opacity: 0; }
        @keyframes pop3d { 0% { opacity:0; transform: translate(-50%,-50%) scale(0.3); } 50% { opacity:1; transform: translate(-50%,-50%) scale(1.3); } 100% { opacity:0; transform: translate(-50%,-50%) scale(1); } }
        @keyframes shake3d { 0%, 100% { transform: translate(-50%,-50%) rotate(0deg); opacity:0; } 10%, 90% { opacity:1; } 20%, 60% { transform: translate(-55%,-50%) rotate(-10deg); } 40%, 80% { transform: translate(-45%,-50%) rotate(10deg); } }
        .pop { animation: pop3d 0.8s forwards; }
        .shake { animation: shake3d 0.8s forwards; }

        /* Buttons & Layout */
        .choice-btn { padding: 12px 20px; border: 2px solid #ddd; border-radius: 25px; background: white; cursor: pointer; transition: 0.3s; margin: 5px; }
        .choice-btn.active { background: #ffeb3b; border-color: #fbc02d; font-weight: bold; }
        .option-btn { padding: 25px; font-size: 38px; font-weight: bold; border-radius: 20px; border: 4px solid #eee; cursor: pointer; background: #fff; box-shadow: 0 8px 0 #ddd; transition: 0.1s; }
        .option-btn:active { box-shadow: 0 2px 0 #ddd; transform: translateY(6px); }
        #settings { position: fixed; bottom: 15px; right: 15px; background: white; border: 2px solid #4CAF50; padding: 10px; border-radius: 15px; text-align: left; width: 230px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-size: 11px; }
        select { width: 100%; margin-bottom: 5px; font-size: 11px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <!-- Bá»˜ Äáº¾M TIáº¾NG NHáº¬T GÃ“C TRÃŠN BÃŠN PHáº¢I -->
    <div id="stats">
        <div><ruby>åˆè¨ˆ<rt>ã”ã†ã‘ã„</rt></ruby>: <span id="total-count">0</span></div>
        <div style="color: #28a745;"><ruby>æ­£è§£<rt>ã›ã„ã‹ã„</rt></ruby>: <span id="correct-count">0</span></div>
        <div style="color: #dc3545;"><ruby>é–“é•ã„<rt>ã¾ã¡ãŒã„</rt></ruby>: <span id="wrong-count">0</span></div>
    </div>

    <div id="effect-layer"></div>

    <div id="setup-screen">
        <h1><ruby>æ•°å­—<rt>ã™ã†ã˜</rt></ruby>ã®<ruby>å­¦ç¿’<rt>ãŒãã—ã‚…ã†</rt></ruby></h1>
        <div style="margin-bottom:20px">
            <strong>â¶ <ruby>å•é¡Œæ•°<rt>ã‚‚ã‚“ã ã„ã™ã†</rt></ruby> (Sá»‘ cÃ¢u)</strong><br>
            <div id="q-group">
                <button class="choice-btn active" onclick="setQ(10, this)">10</button>
                <button class="choice-btn" onclick="setQ(20, this)">20</button>
                <button class="choice-btn" onclick="setQ(30, this)">30</button>
                <button class="choice-btn" onclick="setQ(50, this)">50</button>
            </div>
        </div>
        <div style="margin-bottom:20px">
            <strong>â· <ruby>ç¯„å›²<rt>ã¯ã‚“ã„</rt></ruby> (Pháº¡m vi)</strong><br>
            <div id="r-group">
                <button class="choice-btn active" onclick="setR(1, 10, this)">1-10</button>
                <button class="choice-btn" onclick="setR(10, 100, this)">10-100</button>
                <button class="choice-btn" onclick="setR(100, 1000, this)">100-1k</button>
                <button class="choice-btn" onclick="setR(1000, 10000, this)">1k-1ä¸‡</button>
                <button class="choice-btn" onclick="setR(10000, 1000000, this)">1ä¸‡-100ä¸‡</button>
            </div>
        </div>
        <button onclick="startGame()" style="background:#4CAF50; color:white; padding:15px 50px; font-size:24px; border-radius:50px; cursor:pointer; border:none; font-weight:bold;">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>

    <div id="game-screen" class="hidden">
        <div id="play-btn" style="font-size:80px; cursor:pointer;" onclick="speakTarget()">ğŸ”Š</div>
        <div id="feedback-text" style="font-size:32px; font-weight:bold; height:50px; color:#ff5722; margin-top:10px;"></div>
        <div class="options-grid" id="options" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;"></div>
    </div>

    <div id="end-screen" class="hidden">
        <h1><ruby>çµæœç™ºè¡¨<rt>ã‘ã£ã‹ã¯ã£ã´ã‚‡ã†</rt></ruby></h1>
        <div id="result-summary" style="font-size:30px; margin:30px; padding:20px; background:#fffde7; border-radius:20px;"></div>
        <h2 style="color:#E91E63; font-size:35px;"><ruby>ãŠç–²ã‚Œæ§˜<rt>ãŠã¤ã‹ã‚Œã•ã¾</rt></ruby>ã§ã—ãŸï¼</h2>
        <button onclick="location.reload()" style="background:#2196F3; color:white; padding:15px 40px; border-radius:50px; border:none; cursor:pointer; font-size:20px;">ã‚‚ã†ã„ã¡ã©éŠã¶</button>
    </div>
</div>

<div id="settings">
    <strong>âš™ <ruby>è¨­å®š<rt>ã›ã£ã¦ã„</rt></ruby> (CÃ i Ä‘áº·t)</strong><br>
    ãƒ¢ãƒ¼ãƒ‰ (Cháº¿ Ä‘á»™):
    <select id="voice-mode">
        <option value="jp">ã«ã»ã‚“ã”</option>
        <option value="vi">ãƒ™ãƒˆãƒŠãƒ ã”</option>
        <option value="jp-vi">ã«ã»ã‚“ã” ï¼‹ ãƒ™ãƒˆãƒŠãƒ ã”</option>
    </select>
    ã«ã»ã‚“ã”ã®å£° (Giá»ng Nháº­t):
    <select id="voice-jp"></select>
    ãƒ™ãƒˆãƒŠãƒ ã”ã®å£° (Giá»ng Viá»‡t):
    <select id="voice-vi"></select>
    ã‚¹ãƒ”ãƒ¼ãƒ‰ (Tá»‘c Ä‘á»™):
    <input type="range" id="speed" min="0.5" max="1.5" step="0.1" value="1" style="width:100%">
</div>

<script>
    let correctCount = 0, wrongCount = 0, currentQ = 0;
    let maxQ = 10, rangeMin = 1, rangeMax = 10, targetNum = 0;
    let allVoices = [];

    const goodMsgs = [
        {k:"<ruby>æ­£è§£<rt>ã›ã„ã‹ã„</rt></ruby>ï¼", r:"ã›ã„ã‹ã„"},
        {k:"<ruby>ç´ æ™´ã‚‰ã—ã„<rt>ã™ã°ã‚‰ã—ã„</rt></ruby>ï¼", r:"ã™ã°ã‚‰ã—ã„"},
        {k:"ã‚„ã£ãŸã­ï¼", r:"ã‚„ã£ãŸã­"},
        {k:"ã™ã”ã„ï¼", r:"ã™ã”ã„"},
        {k:"ãã®<ruby>èª¿å­<rt>ã¡ã‚‡ã†ã—</rt></ruby>ï¼", r:"ãã®ã¡ã‚‡ã†ã—"}
    ];
    const badMsgs = [
        {k:"ãŠã—ã„ï¼", r:"ãŠã—ã„"},
        {k:"ãƒ–ãƒ¼ãƒ–ãƒ¼", r:"ãƒ–ãƒ¼ãƒ–ãƒ¼"},
        {k:"ã¡ãŒã†ã‚ˆ", r:"ã¡ãŒã†ã‚ˆ"},
        {k:"<ruby>æ¬¡<rt>ã¤ã</rt></ruby>ã¯<ruby>é ‘å¼µ<rt>ãŒã‚“ã°</rt></ruby>ã‚ã†", r:"ã¤ãã¯ãŒã‚“ã°ã‚ã†"},
        {k:"ã©ã‚“ã¾ã„ï¼", r:"ã©ã‚“ã¾ã„"}
    ];

    function loadVoices() {
        allVoices = window.speechSynthesis.getVoices();
        const jpSelect = document.getElementById('voice-jp');
        const viSelect = document.getElementById('voice-vi');
        jpSelect.innerHTML = ''; viSelect.innerHTML = '';
        allVoices.forEach((v, i) => {
            if (v.lang.includes('ja')) jpSelect.add(new Option(v.name, i));
            if (v.lang.includes('vi')) viSelect.add(new Option(v.name, i));
        });
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;

    function setQ(v, b) { maxQ = v; setActive('q-group', b); }
    function setR(min, max, b) { rangeMin = min; rangeMax = max; setActive('r-group', b); }
    function setActive(id, b) {
        document.querySelectorAll(`#${id} button`).forEach(btn => btn.classList.remove('active'));
        b.classList.add('active');
    }

    function startGame() {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        nextQuestion();
    }

    function nextQuestion() {
        if (currentQ >= maxQ) return endGame();
        currentQ++;
        updateStats();
        targetNum = Math.floor(Math.random() * (rangeMax - rangeMin + 1)) + rangeMin;
        const container = document.getElementById('options');
        container.innerHTML = "";
        let choices = [targetNum];
        while(choices.length < 4) {
            let fake = targetNum + (Math.floor(Math.random()*11) - 5);
            if (fake > 0 && !choices.includes(fake)) choices.push(fake);
        }
        choices.sort(() => Math.random() - 0.5);
        choices.forEach(num => {
            let b = document.createElement('button');
            b.className = 'option-btn';
            b.innerText = num.toLocaleString();
            b.onclick = () => check(num, b);
            container.appendChild(b);
        });
        setTimeout(speakTarget, 500);
    }

    function speakTarget() {
        const mode = document.getElementById('voice-mode').value;
        const rate = parseFloat(document.getElementById('speed').value);
        const jpV = allVoices[document.getElementById('voice-jp').value];
        const viV = allVoices[document.getElementById('voice-vi').value];
        if (mode === 'jp') speak(targetNum, jpV, rate);
        else if (mode === 'vi') speak(targetNum, viV, rate);
        else speak(targetNum, jpV, rate, () => speak(targetNum, viV, rate));
    }

    function speak(text, voice, rate, callback) {
        if (!voice) return callback ? callback() : null;
        const ut = new SpeechSynthesisUtterance(text);
        ut.voice = voice; ut.rate = rate;
        if (callback) ut.onend = callback;
        window.speechSynthesis.speak(ut);
    }

    function check(sel, btn) {
        const effect = document.getElementById('effect-layer');
        const feed = document.getElementById('feedback-text');
        const jpV = allVoices[document.getElementById('voice-jp').value];
        effect.className = "";
        if (sel === targetNum) {
            correctCount++;
            effect.innerText = "â­•";
            void effect.offsetWidth;
            effect.classList.add('pop');
            const m = goodMsgs[Math.floor(Math.random()*5)];
            feed.innerHTML = m.k;
            speak(m.r, jpV, 1.2);
            setTimeout(nextQuestion, 1800);
        } else {
            wrongCount++;
            effect.innerText = "âŒ";
            void effect.offsetWidth;
            effect.classList.add('shake');
            const m = badMsgs[Math.floor(Math.random()*5)];
            feed.innerHTML = m.k;
            speak(m.r, jpV, 1.2);
            btn.style.background = "#ffcdd2";
        }
        updateStats();
    }

    function updateStats() {
        document.getElementById('total-count').innerText = currentQ;
        document.getElementById('correct-count').innerText = correctCount;
        document.getElementById('wrong-count').innerText = wrongCount;
    }

    function endGame() {
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('result-summary').innerHTML = 
            `<ruby>æ­£è§£<rt>ã›ã„ã‹ã„</rt></ruby>: ${correctCount} <br> ` +
            `<ruby>é–“é•ã„<rt>ã¾ã¡ãŒã„</rt></ruby>: ${wrongCount}`;
    }
</script>
</body>
</html>